from registry import registry
from utils.logger import Logger


@registry.registered(registry.STOPPER, "poker_oracle_exploitablitiy_stopper")
class PokerOracleExploitablityStopper:
    def __init__(self, **kwargs):
        self.percentage = kwargs["min_reward_thresh_percent"]
        self.policy_data_manager = kwargs["policy_data_manager"]
        # divide by 2 because nash conv is the sum of two players
        self.min_reward_thresh = (
            self.percentage * self.policy_data_manager.nash_eq_exploitabilities[-1] / 2
        )
        self.max_steps = kwargs["max_steps"]

    def stop(self, **kwargs):
        step = kwargs["step"]
        reward = kwargs["reward"]
        Logger.info(
            "<Step {}> reward: {}, min_reward_thresh: {}".format(
                step, reward, self.min_reward_thresh
            )
        )
        if step >= self.max_steps or reward >= self.min_reward_thresh:
            return True
        return False
